<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관계 분석 결과 - Date Genie | AI 기반 심리 분석 서비스</title>
    <meta name="description" content="AI 기반 대화 분석을 통한 정확한 관계 상태 파악과 맞춤화된 발전 전략 제공">
    <meta name="keywords" content="대화분석, 심리분석, 관계분석, AI분석, 연애조언">
    <meta name="author" content="Date Genie Team">
    <meta property="og:title" content="관계 분석 결과 - Date Genie">
    <meta property="og:description" content="AI 기반 대화 분석 결과와 맞춤화된 관계 발전 전략">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/svg+xml" href="images/icon.svg">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === Enhanced CSS Variables & System === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        :root {
            /* Color System */
            --color-primary-50: #faf5ff;
            --color-primary-100: #f3e8ff;
            --color-primary-500: #8b5cf6;
            --color-primary-600: #7c3aed;
            --color-primary-700: #6d28d9;
            
            --color-accent-50: #fdf2f8;
            --color-accent-500: #ec4899;
            --color-accent-600: #db2777;
            
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-500: #6b7280;
            --color-gray-900: #1f1d3a;
            
            /* Spacing System */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Typography */
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* Component Variables */
            --navbar-height: 70px;
            --primary-gradient: linear-gradient(135deg, var(--color-accent-500), var(--color-primary-500));
            --success-color: var(--color-success);
            --warning-color: var(--color-warning);
            --danger-color: var(--color-danger);
            --info-color: var(--color-info);
            --text-primary: var(--color-gray-900);
            --text-secondary: var(--color-gray-500);
            --bg-card: rgba(255, 255, 255, 0.95);
            --shadow-primary: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
            
            /* Accessibility */
            --focus-outline: 3px solid var(--color-primary-500);
            --focus-outline-offset: 2px;
            
            /* Animation */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-accent-50) 40%, #eef2ff 100%);
            min-height: 100vh;
            scroll-behavior: smooth;
        }
        
        body:focus {
            outline: none;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --bg-card: rgba(255, 255, 255, 1);
                --shadow-primary: 0 2px 8px rgba(0, 0, 0, 0.25);
            }
        }

        /* === Navigation === */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .heart-icon {
            color: #ec4899;
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            background: rgba(124, 58, 237, 0.1);
            color: var(--text-primary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        /* === Main Container === */
        .results-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: calc(var(--navbar-height) + 2rem) 1rem 3rem;
        }

        /* === Card System === */
        .result-card {
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* === Two Column Layout System === */
        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .column-card {
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .column-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* === Hero Success Dashboard === */
        .hero-dashboard {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
            position: relative;
        }

        .success-meter {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
        }

        .success-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #ec4899 0%, #8b5cf6 76%, #f3f4f6 76%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: scaleIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .success-circle::before {
            content: '';
            position: absolute;
            inset: 20px;
            background: white;
            border-radius: 50%;
        }

        .success-percentage {
            position: absolute;
            font-size: 3rem;
            font-weight: 800;
            color: #7c3aed;
            z-index: 2;
        }

        .relationship-status {
            margin-bottom: 1rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.75rem 2rem;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(236, 72, 153, 0.3);
        }

        .hero-insight {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1.5rem 0;
            line-height: 1.4;
        }

        .confidence-level {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--success-color);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* === Chart Containers === */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        /* === Section Headers === */
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .section-title h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* === Signal Components === */
        .signal-list {
            list-style: none;
        }

        .signal-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .signal-item:last-child {
            border-bottom: none;
        }

        .signal-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        .positive-signal .signal-icon {
            background: var(--success-color);
        }

        .warning-signal .signal-icon {
            background: var(--warning-color);
        }

        .signal-content {
            flex: 1;
        }

        .signal-text {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .signal-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .confidence-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .confidence-stars {
            color: #fbbf24;
        }

        /* === Favorite Message Component === */
        .favorite-message {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(139, 92, 246, 0.05));
            border: 2px solid rgba(236, 72, 153, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .message-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .message-text {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            font-style: italic;
            color: var(--text-primary);
            border-left: 4px solid #ec4899;
            margin: 1rem 0;
            position: relative;
            font-size: 1.05rem;
            line-height: 1.5;
        }

        .message-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* === Conversation Guide === */
        .conversation-examples {
            display: grid;
            gap: 1rem;
        }

        .conversation-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1rem;
            border-left: 4px solid var(--info-color);
        }

        .conversation-type {
            font-weight: 600;
            color: var(--info-color);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .conversation-text {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .conversation-timing {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* === Advice Component === */
        .advice-item {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin: 0.75rem 0;
        }

        .advice-title {
            font-weight: 600;
            color: var(--warning-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .advice-content {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* === Sticky Note Style === */
        .sticky-note {
            background: #ffeb3b;
            color: #333;
            font-family: 'Malgun Gothic', sans-serif;
            padding: 1.2rem 1.5rem;
            margin: 2rem 0;
            transform: rotate(-1deg);
            border-radius: 0;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
            position: relative;
            border: 1px solid #f9c74f;
        }

        .sticky-note::before {
            content: '📌';
            position: absolute;
            top: -8px;
            right: 15px;
            font-size: 1.3rem;
        }

        /* === Action Buttons === */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-primary, .btn-secondary {
            padding: 1rem 2rem;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            box-shadow: 0 8px 25px rgba(236, 72, 153, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(236, 72, 153, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: #7c3aed;
            border: 2px solid rgba(124, 58, 237, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: rgba(124, 58, 237, 0.5);
            transform: translateY(-1px);
        }

        /* === Animations === */
        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* === Responsive Design === */
        @media (max-width: 768px) {
            .results-container {
                padding: calc(var(--navbar-height) + 1rem) 0.5rem 2rem;
            }

            .two-column-grid,
            .action-buttons {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .result-card,
            .column-card {
                padding: 1.5rem;
                border-radius: 20px;
            }

            .hero-dashboard {
                padding: 2rem 1rem;
            }

            .success-meter {
                width: 160px;
                height: 160px;
            }

            .success-percentage {
                font-size: 2.5rem;
            }

            .hero-insight {
                font-size: 1.1rem;
            }

            .chart-container {
                height: 250px;
                padding: 0.75rem;
            }
        }

        /* === Enhanced Accessibility === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--color-primary-600);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 9999;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* Enhanced focus styles */
        button:focus,
        .btn-primary:focus,
        .btn-secondary:focus,
        a:focus {
            outline: var(--focus-outline);
            outline-offset: var(--focus-outline-offset);
        }
        
        /* Focus indicators for interactive elements */
        .result-card:focus-within {
            outline: 2px solid var(--color-primary-500);
            outline-offset: 2px;
        }
        
        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .success-circle {
                animation: none;
            }
            
            .result-card,
            .column-card {
                transition: none;
            }
        }
        
        /* High contrast mode enhancements */
        @media (prefers-contrast: high) {
            .signal-icon,
            .section-icon {
                border: 2px solid currentColor;
            }
            
            .btn-primary,
            .btn-secondary {
                border: 2px solid currentColor;
            }
        }
        
        /* Print styles */
        @media print {
            .navbar,
            .action-buttons {
                display: none;
            }
            
            .results-container {
                padding-top: 0;
            }
            
            .result-card,
            .column-card {
                box-shadow: none;
                border: 1px solid #000;
                background: white;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/DateGenie/index.html" class="brand-logo">
                <i class="fas fa-heart heart-icon"></i>
                <span>Date Genie</span>
            </a>
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="userName">사용자님</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="results-container">
        <!-- 1. 호감도 (최상단) -->
        <div class="result-card hero-dashboard">
            <div class="relationship-status">
                <div class="status-badge" id="relationshipStage">썸 가능성 높음</div>
            </div>
            
            <div class="success-meter">
                <div class="success-circle" id="successCircle">
                    <div class="success-percentage" id="successPercentage">76%</div>
                </div>
            </div>

            <h1 class="hero-insight" id="heroInsight">
                상대방이 당신에게 호감을 가지고 있을 확률이 높습니다
            </h1>

            <div class="confidence-level">
                <i class="fas fa-shield-check"></i>
                <span>분석 신뢰도: <strong id="confidenceLevel">83%</strong></span>
            </div>
        </div>

        <!-- 2. 호감도 변화 추이 + 감정분석 (2열) -->
        <div class="two-column-grid">
            <div class="column-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="section-title">
                        <h3>호감도 변화 추이</h3>
                        <p class="section-subtitle">최근 10일간 관심도 변화</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="interestChart"></canvas>
                </div>
            </div>

            <div class="column-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="section-title">
                        <h3>감정 분석</h3>
                        <p class="section-subtitle">대화 톤 감정 분포</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="emotionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 3. 발견된 호감 신호 + 대표 호감문장 (2열) -->
        <div class="two-column-grid">
            <div class="column-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="section-title">
                        <h3>발견된 호감 신호</h3>
                        <p class="section-subtitle">긍정적 신호 분석</p>
                    </div>
                </div>
                <ul class="signal-list" id="positiveSignals">
                    <!-- 동적 생성 -->
                </ul>
            </div>

            <div class="column-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-quote-right"></i>
                    </div>
                    <div class="section-title">
                        <h3>대표 호감문장</h3>
                        <p class="section-subtitle">가장 호감도가 높은 메시지</p>
                    </div>
                </div>
                <div class="favorite-message" id="favoriteMessage">
                    <!-- 동적 생성 -->
                </div>
            </div>
        </div>

        <!-- 4. 실전 대화 가이드 + 맞춤 조언 (2열) -->
        <div class="two-column-grid">
            <div class="column-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="section-title">
                        <h3>실전 대화 가이드</h3>
                        <p class="section-subtitle">바로 사용할 메시지</p>
                    </div>
                </div>
                <div class="conversation-examples" id="conversationGuide">
                    <!-- 동적 생성 -->
                </div>
            </div>

            <div class="column-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="section-title">
                        <h3>맞춤 조언</h3>
                        <p class="section-subtitle">상황별 추천 행동</p>
                    </div>
                </div>
                <div class="advice-list" id="customAdvice">
                    <!-- 동적 생성 -->
                </div>
            </div>
        </div>

        <!-- 5. 스티키 노트 -->
        <div class="sticky-note">
            📝 참고: 이 모든 건 제 개인적인 의견이에요! 100% 맞다는 보장은 없어요 ㅋㅋ 그래도 참고는 되실 거예요?
        </div>

        <!-- 6. 새로운 분석 + 분석 히스토리 (2열) -->
        <div class="action-buttons">
            <a href="/DateGenie/upload.html" class="btn-primary">
                <i class="fas fa-upload"></i>
                새로운 분석하기
            </a>
            <a href="/DateGenie/dashboard.html" class="btn-secondary">
                <i class="fas fa-chart-line"></i>
                분석 히스토리 보기
            </a>
        </div>
    </div>

    <!-- Screen Reader Announcements -->
    <div class="sr-only" aria-live="polite" id="announcements"></div>

    <script>
        // === 동적 데이터 로딩 ===
        let analysisData = null;
        
        // 페이지 로드 시 분석 데이터 초기화
        async function initializeAnalysisData() {
            try {
                // URL에서 sessionId 파라미터 확인
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId');
                
                console.log('데이터 초기화 시작 - sessionId:', sessionId);
                
                if (sessionId) {
                    // 1. 우선 API에서 최신 데이터 가져오기 시도
                    console.log('API에서 분석 데이터 로드 시도:', sessionId);
                    try {
                        analysisData = await fetchAnalysisResult(sessionId);
                        
                        if (analysisData && Object.keys(analysisData).length > 0) {
                            // API에서 성공적으로 데이터를 가져온 경우 localStorage에 저장
                            localStorage.setItem('analysisResult', JSON.stringify(analysisData));
                            localStorage.setItem('analysisSessionId', sessionId);
                            console.log('API 데이터 로드 성공 및 localStorage 저장 완료');
                        } else {
                            throw new Error('API에서 빈 데이터 응답');
                        }
                    } catch (apiError) {
                        console.warn('API 데이터 로드 실패, localStorage 확인:', apiError.message);
                        
                        // 2. API 실패시 localStorage에서 확인
                        const storedResult = localStorage.getItem('analysisResult');
                        const storedSessionId = localStorage.getItem('analysisSessionId');
                        
                        if (storedResult && storedSessionId === sessionId) {
                            console.log('localStorage에서 일치하는 데이터 발견');
                            analysisData = JSON.parse(storedResult);
                        } else {
                            throw new Error('로컬 저장소에 일치하는 데이터 없음');
                        }
                    }
                } else {
                    // sessionId가 없는 경우 localStorage에서 최근 분석 결과 확인
                    const storedResult = localStorage.getItem('analysisResult');
                    
                    if (storedResult) {
                        console.log('sessionId 없음, localStorage에서 최근 데이터 사용');
                        analysisData = JSON.parse(storedResult);
                    } else {
                        console.log('저장된 데이터 없음, 업로드 페이지로 리다이렉트');
                        window.location.href = '/DateGenie/upload.html?message=분석할 데이터가 없습니다';
                        return;
                    }
                }
                
                // 데이터 검증 및 기본값 설정
                analysisData = validateAndNormalizeData(analysisData);
                
                console.log('최종 분석 데이터:', analysisData);
                
            } catch (error) {
                console.error('분석 데이터 로드 실패:', error);
                
                // 최종 실패시 처리
                console.log('모든 데이터 로드 방법 실패, 업로드 페이지로 이동');
                
                // 사용자에게 알림 후 업로드 페이지로 리다이렉트
                alert('분석 결과를 불러올 수 없습니다. 새로운 분석을 시작해주세요.');
                window.location.href = '/DateGenie/upload.html?message=분석 결과를 불러올 수 없습니다';
                return;
            }
        }
        
        // API에서 분석 결과 가져오기 (Anthropic + 기존 지원)
        async function fetchAnalysisResult(sessionId) {
            try {
                console.log('API 호출 시작 - sessionId:', sessionId);
                
                // 우선 Anthropic 컨트롤러에서 시도
                let response = await fetch(`/DateGenie/AnthropicAnalysisController?action=getResult&sessionId=${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                console.log('Anthropic API 응답 상태:', response.status);
                
                // Anthropic API 실패시 기존 AnalysisService로 폴백
                if (!response.ok || response.status !== 200) {
                    console.log('Anthropic API 실패, 기존 AnalysisService로 폴백 시도');
                    
                    response = await fetch(`/DateGenie/AnalysisService?action=getResult&sessionId=${sessionId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json; charset=UTF-8',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    
                    console.log('기존 API 응답 상태:', response.status);
                }
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('분석 결과를 찾을 수 없습니다.');
                    } else if (response.status === 401) {
                        window.location.href = '/DateGenie/login.html?message=로그인이 필요합니다';
                        return;
                    } else {
                        throw new Error(`서버 오류: ${response.status} ${response.statusText}`);
                    }
                }
                
                const result = await response.json();
                console.log('API 응답 데이터:', result);
                
                if (!result.success) {
                    throw new Error(result.message || '분석 결과 조회에 실패했습니다.');
                }
                
                if (!result.analysisData || Object.keys(result.analysisData).length === 0) {
                    throw new Error('분석 데이터가 비어있습니다.');
                }
                
                console.log('API에서 성공적으로 데이터 수신:', Object.keys(result.analysisData));
                return result.analysisData;
                
            } catch (error) {
                console.error('fetchAnalysisResult 오류:', error);
                throw error;
            }
        }
        
        // 향상된 데이터 검증 및 정규화 시스템
        function validateAndNormalizeData(data) {
            console.log('데이터 검증 시작:', data);
            
            // 데이터 무결성 검사
            const dataIntegrityScore = calculateDataIntegrity(data);
            console.log('데이터 무결성 점수:', dataIntegrityScore);
            
            // 새로운 JSON 스키마에 맞게 데이터 매핑
            const mainResults = data.mainResults || {};
            const emotionAnalysis = data.emotionAnalysis || {};
            
            // 기본 구조 확인 및 기본값 설정
            const normalized = {
                successRate: validateNumericRange(mainResults.successRate, 0, 100, 0),
                confidenceLevel: validateNumericRange(mainResults.confidenceLevel, 0, 100, 0),
                relationshipStage: mainResults.relationshipStage || "분석 중",
                heroInsight: mainResults.heroInsight || mainResults.summary || "분석을 진행하고 있습니다.",
                dataQualityScore: dataIntegrityScore,
                
                interestTrendData: validateTrendData(data.interestTrends),
                emotionData: validateEmotionData(emotionAnalysis),
                positiveSignals: validateSignalsData(data.positiveSignals),
                favoriteMessage: data.favoriteMessage || {
                    text: "분석된 메시지가 없습니다.",
                    confidence: 0,
                    date: "날짜 없음",
                    reason: "메시지 분석 중"
                },
                conversationGuide: data.conversationGuides || [],
                customAdvice: data.customAdvice || []
            };
            
            // 빈 데이터에 대한 기본값 설정
            if (normalized.interestTrendData.length === 0) {
                normalized.interestTrendData = getDefaultTrendData();
            }
            
            if (normalized.conversationGuide.length === 0) {
                normalized.conversationGuide = getDefaultConversationGuide();
            }
            
            if (normalized.customAdvice.length === 0) {
                normalized.customAdvice = getDefaultCustomAdvice();
            }
            
            // 최종 데이터 무결성 재검증
            const finalIntegrityCheck = performFinalValidation(normalized);
            if (!finalIntegrityCheck.valid) {
                console.warn('데이터 무결성 경고:', finalIntegrityCheck.issues);
                // 사용자에게 알림 (UI 개선 전에는 주석 처리)
                // showDataQualityWarning(finalIntegrityCheck.issues);
            }
            
            console.log('정규화 완료:', normalized);
            return normalized;
        }
        
        // 수치 범위 검증 함수
        function validateNumericRange(value, min, max, defaultValue) {
            const num = Number(value);
            if (isNaN(num) || num < min || num > max) {
                console.warn(`수치 범위 오류: ${value} (범위: ${min}-${max})`);
                return defaultValue;
            }
            return Math.round(num * 10) / 10; // 소수점 1자리로 제한
        }
        
        // 추이 데이터 검증
        function validateTrendData(trendData) {
            if (!Array.isArray(trendData) || trendData.length === 0) {
                return getDefaultTrendData();
            }
            
            return trendData.map(item => ({
                date: item.date || '날짜 없음',
                value: validateNumericRange(item.value, 0, 100, 0),
                messageCount: validateNumericRange(item.messageCount, 0, 1000, 0),
                avgResponseTime: validateNumericRange(item.avgResponseTime, 0, 1440, 0) // 24시간 최대
            }));
        }
        
        // 감정 데이터 검증
        function validateEmotionData(emotionData) {
            if (!emotionData || typeof emotionData !== 'object') {
                return { positive: 0, neutral: 0, negative: 0 };
            }
            
            const positive = validateNumericRange(emotionData.positive, 0, 100, 0);
            const neutral = validateNumericRange(emotionData.neutral, 0, 100, 0);
            const negative = validateNumericRange(emotionData.negative, 0, 100, 0);
            
            // 합계 100% 맞추기
            const total = positive + neutral + negative;
            if (total === 0) {
                return { positive: 0, neutral: 0, negative: 0 };
            }
            
            return {
                positive: Math.round((positive / total) * 1000) / 10,
                neutral: Math.round((neutral / total) * 1000) / 10,
                negative: Math.round((negative / total) * 1000) / 10
            };
        }
        
        // 신호 데이터 검증
        function validateSignalsData(signalsData) {
            if (!Array.isArray(signalsData) || signalsData.length === 0) {
                return [];
            }
            
            return signalsData.map(signal => ({
                text: signal.text || '알 수 없는 신호',
                description: signal.description || '설명 없음',
                confidence: validateNumericRange(signal.confidence, 1, 5, 1),
                type: signal.type || 'unknown',
                metricValue: signal.metricValue || 0,
                metricUnit: signal.metricUnit || ''
            }));
        }
        
        // 데이터 무결성 계산
        function calculateDataIntegrity(data) {
            let score = 100;
            
            // API 응답 구조에 맞게 mainResults에서 필드 검사
            const mainResults = data.mainResults || {};
            const requiredFields = ['successRate', 'confidenceLevel', 'relationshipStage', 'heroInsight'];
            
            requiredFields.forEach(field => {
                if (!mainResults[field] && !data[field]) score -= 10;
            });
            
            // 데이터 타입 검사 (mainResults 우선, 없으면 data에서)
            const successRate = mainResults.successRate || data.successRate;
            const confidenceLevel = mainResults.confidenceLevel || data.confidenceLevel;
            
            if (typeof successRate !== 'number') score -= 5;
            if (typeof confidenceLevel !== 'number') score -= 5;
            
            // 데이터 논리성 검사
            if (successRate > 100 || successRate < 0) score -= 15;
            if (confidenceLevel > 100 || confidenceLevel < 0) score -= 15;
            
            return Math.max(0, score);
        }
        
        // 최종 검증
        function performFinalValidation(data) {
            const issues = [];
            
            if (data.dataQualityScore < 80) {
                issues.push('데이터 품질이 낮습니다.');
            }
            
            if (data.successRate === 0 && data.confidenceLevel === 0) {
                issues.push('분석 데이터가 부족합니다.');
            }
            
            return {
                valid: issues.length === 0,
                issues: issues
            };
        }
        
        // 기본 추이 데이터
        function getDefaultTrendData() {
            return [
                { date: '8월 13일', value: 45 },
                { date: '8월 14일', value: 52 },
                { date: '8월 15일', value: 48 },
                { date: '8월 16일', value: 58 },
                { date: '8월 17일', value: 62 },
                { date: '8월 18일', value: 59 },
                { date: '8월 19일', value: 67 },
                { date: '8월 20일', value: 71 },
                { date: '8월 21일', value: 69 },
                { date: '8월 22일', value: 76 }
            ];
        }
        
        // 기본 대화 가이드
        function getDefaultConversationGuide() {
            return [
                {
                    type: "일상 공유",
                    text: "오늘 하루 어때? 나는 좋은 일이 있어서 기분이 좋아 ㅎㅎ",
                    timing: "오후 6-9시 추천",
                    category: "casual",
                    difficultyLevel: 1
                },
                {
                    type: "관심사 질문",
                    text: "요즘 뭐 재밌는 거 있어? 나도 새로운 거 찾고 있어서~",
                    timing: "저녁 시간대",
                    category: "interest",
                    difficultyLevel: 2
                },
                {
                    type: "가벼운 제안",
                    text: "날씨 좋은 날 산책이라도 한번 해볼까? 부담없이~",
                    timing: "주말 오전",
                    category: "meetup",
                    difficultyLevel: 3
                }
            ];
        }
        
        // 기본 맞춤 조언
        function getDefaultCustomAdvice() {
            return [
                {
                    title: "현재 단계에서는",
                    content: "자연스럽고 부담스럽지 않은 대화를 이어가는 것이 좋습니다. 상대방의 반응을 살피며 점진적으로 관심을 표현하세요.",
                    type: "current_stage",
                    priority: 1,
                    urgency: "Medium"
                },
                {
                    title: "다음 단계 준비",
                    content: "공통 관심사를 찾아 가벼운 활동을 함께 할 수 있는 기회를 만들어보세요.",
                    type: "next_step",
                    priority: 2,
                    urgency: "Low"
                },
                {
                    title: "주의사항",
                    content: "너무 급하게 관계를 발전시키려 하지 말고, 상대방의 페이스를 존중하며 소통하세요.",
                    type: "caution",
                    priority: 3,
                    urgency: "Medium"
                }
            ];
        }
        
        // 데모/기본 데이터
        function getDefaultAnalysisData() {
            return {
                successRate: 76,
                confidenceLevel: 83,
                relationshipStage: "썸 가능성 높음",
                heroInsight: "상대방이 당신에게 호감을 가지고 있을 확률이 높습니다",
                
                interestTrendData: getDefaultTrendData(),
                
                emotionData: {
                    positive: 64,
                    neutral: 23,
                    negative: 13
                },
                
                positiveSignals: [
                    {
                        text: "응답 속도 향상",
                        description: "평균 응답 시간이 3분 이내로 단축됨",
                        confidence: 5
                    },
                    {
                        text: "이모티콘 사용 증가",
                        description: "대화에서 이모티콘 사용 빈도가 40% 증가",
                        confidence: 4
                    },
                    {
                        text: "개인적 질문 증가",
                        description: "일상이나 근황에 대한 질문이 늘어남",
                        confidence: 4
                    },
                    {
                        text: "미래 계획 언급",
                        description: "함께할 활동에 대한 언급이 자주 나타남",
                        confidence: 5
                    }
                ],
                
                favoriteMessage: {
                    text: "아 오늘 지나가다가 그 카페 봤는데 너 생각났어 ㅋㅋ 언제 같이 가볼까? 😊",
                    confidence: 92,
                    date: "8월 20일 오후 3:24",
                    reason: "자연스러운 만남 제안과 개인적 관심 표현"
                },
                
                conversationGuide: getDefaultConversationGuide(),
                
                customAdvice: [
                    {
                        title: "지금 단계에서는",
                        content: "상대방이 보내는 긍정적 신호를 놓치지 말고, 자연스럽게 대화를 이어가세요. 너무 급하지 않게!"
                    },
                    {
                        title: "다음 스텝",
                        content: "공통 관심사를 중심으로 가벼운 만남을 제안해보세요. 부담스럽지 않은 선에서 시작하는 것이 좋습니다."
                    },
                    {
                        title: "주의사항",
                        content: "밤늦은 시간 연락은 조금 줄이고, 상대방의 생활 패턴을 존중하는 모습을 보여주세요."
                    }
                ]
            };
        }

        // === UI Controllers ===
        class ResultsFinalController {
            constructor(data) {
                this.data = data;
                this.init();
            }

            init() {
                // 데이터 품질 채크
                this.performQualityCheck();
                
                // 접근성 초기화
                this.setupAccessibility();
                
                // UI 컴포넌트 렌더링
                this.updateHeroDashboard();
                this.renderSignals();
                this.renderFavoriteMessage();
                this.renderConversationGuide();
                this.renderCustomAdvice();
                
                // 인터렉션 및 애니메이션
                this.setupInteractions();
                this.startAnimations();
                
                // 성능 모니터링
                this.setupPerformanceMonitoring();
                
                // 점진적 강화 - 차트 렌더링을 대역폭 및 기기 성능을 고려하여 지연 처리
                this.scheduleChartInitialization();
            }
            
            performQualityCheck() {
                console.log('데이터 품질 채크:', this.data.dataQualityScore || '점수 없음');
                
                if (this.data.dataQualityScore && this.data.dataQualityScore < 70) {
                    this.showQualityWarning();
                }
            }
            
            setupAccessibility() {
                // ARIA labels 및 역할 설정
                document.querySelectorAll('.chart-container canvas').forEach((canvas, index) => {
                    canvas.setAttribute('role', 'img');
                    canvas.setAttribute('aria-label', `분석 차트 ${index + 1}`);
                });
                
                // 키보드 네비게이션 개선
                this.setupKeyboardNavigation();
                
                // 스크린 리더 공지사항 설정
                this.setupScreenReaderAnnouncements();
            }
            
            setupKeyboardNavigation() {
                // 카드에 tabindex 추가로 키보드 네비게이션 가능
                document.querySelectorAll('.result-card, .column-card').forEach(card => {
                    card.setAttribute('tabindex', '0');
                    card.setAttribute('role', 'article');
                });
            }
            
            setupScreenReaderAnnouncements() {
                const announcements = document.getElementById('announcements');
                if (announcements) {
                    // 초기 로드 완료 공지
                    setTimeout(() => {
                        announcements.textContent = '분석 결과 페이지가 로드되었습니다.';
                    }, 1000);
                }
            }
            
            setupPerformanceMonitoring() {
                // 성능 측정 시작
                performance.mark('results-page-start');
                
                // 렌더링 완료 후 성능 측정
                requestAnimationFrame(() => {
                    performance.mark('results-page-end');
                    performance.measure('results-page-render', 'results-page-start', 'results-page-end');
                    
                    const measure = performance.getEntriesByName('results-page-render')[0];
                    console.log(`페이지 렌더링 시간: ${measure.duration.toFixed(2)}ms`);
                });
            }
            
            scheduleChartInitialization() {
                // 네트워크 및 기기 상태에 따른 최적화
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                let delay = 1000; // 기본 지연
                
                if (connection) {
                    // 느린 네트워크에서는 더 오래 대기
                    if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                        delay = 2000;
                    } else if (connection.effectiveType === '3g') {
                        delay = 1500;
                    }
                }
                
                setTimeout(() => {
                    this.initCharts();
                }, delay);
            }
            
            showQualityWarning() {
                // 데이터 품질 경고 메시지 표시 (미래 개선에 비해 주석 처리)
                console.warn('데이터 품질 경고: 분석 결과의 정확도가 낮을 수 있습니다.');
                // TODO: UI로 사용자에게 알림 표시
            }

            updateHeroDashboard() {
                // 로딩 상태일 때는 hero-dashboard 전체를 재구성
                const heroSection = document.querySelector('.hero-dashboard');
                if (!heroSection) return;
                
                // 원본 HTML 구조로 복원
                heroSection.innerHTML = `
                    <div class="relationship-status">
                        <div class="status-badge" id="relationshipStage">${this.data.relationshipStage}</div>
                    </div>
                    
                    <div class="success-meter">
                        <div class="success-circle" id="successCircle">
                            <div class="success-percentage" id="successPercentage">${this.data.successRate}%</div>
                        </div>
                    </div>

                    <h1 class="hero-insight" id="heroInsight">
                        ${this.data.heroInsight}
                    </h1>

                    <div class="confidence-level">
                        <i class="fas fa-shield-check"></i>
                        <span>분석 신뢰도: <strong id="confidenceLevel">${this.data.confidenceLevel}%</strong></span>
                    </div>
                `;
                
                // Success rate 애니메이션
                setTimeout(() => {
                    const successCircle = document.getElementById('successCircle');
                    if (successCircle) {
                        successCircle.style.background = 
                            `conic-gradient(from 0deg, #ec4899 0%, #8b5cf6 ${this.data.successRate}%, #f3f4f6 ${this.data.successRate}%)`;
                    }
                }, 500);
            }

            renderSignals() {
                const container = document.getElementById('positiveSignals');
                container.innerHTML = this.data.positiveSignals.map(signal => `
                    <li class="signal-item positive-signal">
                        <div class="signal-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="signal-content">
                            <div class="signal-text">${signal.text}</div>
                            <div class="signal-description">${signal.description}</div>
                            <div class="confidence-indicator">
                                <span class="confidence-stars">
                                    ${'★'.repeat(signal.confidence)}${'☆'.repeat(5 - signal.confidence)}
                                </span>
                                <span style="font-size: 0.8rem; margin-left: 0.5rem;">신뢰도</span>
                            </div>
                        </div>
                    </li>
                `).join('');
            }

            renderFavoriteMessage() {
                const container = document.getElementById('favoriteMessage');
                const message = this.data.favoriteMessage;
                
                container.innerHTML = `
                    <div class="message-badge">호감도 ${message.confidence}%</div>
                    <div class="message-text">${message.text}</div>
                    <div class="message-meta">
                        <i class="fas fa-clock"></i>
                        <span>${message.date}</span>
                        <span>•</span>
                        <span>${message.reason}</span>
                    </div>
                `;
            }

            renderConversationGuide() {
                const container = document.getElementById('conversationGuide');
                container.innerHTML = this.data.conversationGuide.map(item => `
                    <div class="conversation-item">
                        <div class="conversation-type">${item.type}</div>
                        <div class="conversation-text">${item.text}</div>
                        <div class="conversation-timing">💡 ${item.timing}</div>
                    </div>
                `).join('');
            }

            renderCustomAdvice() {
                const container = document.getElementById('customAdvice');
                container.innerHTML = this.data.customAdvice.map(advice => `
                    <div class="advice-item">
                        <div class="advice-title">
                            <i class="fas fa-lightbulb"></i>
                            ${advice.title}
                        </div>
                        <div class="advice-content">${advice.content}</div>
                    </div>
                `).join('');
            }

            initCharts() {
                // 관심도 변화 추이 차트
                const interestCtx = document.getElementById('interestChart').getContext('2d');
                new Chart(interestCtx, {
                    type: 'line',
                    data: {
                        labels: this.data.interestTrendData.map(item => item.date),
                        datasets: [{
                            label: '관심도 지수',
                            data: this.data.interestTrendData.map(item => item.value),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#8b5cf6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                grid: { color: 'rgba(139, 92, 246, 0.1)' },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                grid: { color: 'rgba(139, 92, 246, 0.1)' }
                            }
                        }
                    }
                });

                // 감정 분석 차트
                const emotionCtx = document.getElementById('emotionChart').getContext('2d');
                new Chart(emotionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['긍정적 😊', '중립적 😐', '부정적 😔'],
                        datasets: [{
                            data: [
                                this.data.emotionData.positive,
                                this.data.emotionData.neutral,
                                this.data.emotionData.negative
                            ],
                            backgroundColor: ['#10b981', '#6b7280', '#ef4444'],
                            borderWidth: 0,
                            cutout: '60%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }

            startAnimations() {
                // 모션 감소 설정 고려
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                
                if (prefersReducedMotion) {
                    // 모션 감소 사용자를 위한 처리
                    document.querySelectorAll('.result-card, .column-card').forEach(card => {
                        card.style.opacity = '1';
                        card.style.transform = 'none';
                    });
                    return;
                }
                
                // 일반 애니메이션
                const cards = document.querySelectorAll('.result-card, .column-card');
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                setTimeout(() => {
                                    entry.target.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                                    entry.target.style.opacity = '1';
                                    entry.target.style.transform = 'translateY(0)';
                                }, index * 100);
                                observer.unobserve(entry.target);
                            }
                        });
                    }, {
                        threshold: 0.1
                    });
                    
                    observer.observe(card);
                });
            }

            setupInteractions() {
                // 상세 접근성 공지
                setTimeout(() => {
                    const announcement = `분석 완료. 관계 성공 확률 ${this.data.successRate}퍼센트, 신뢰도 ${this.data.confidenceLevel}퍼센트입니다. 자세한 분석 결과를 확인하세요.`;
                    const announcements = document.getElementById('announcements');
                    if (announcements) {
                        announcements.textContent = announcement;
                    }
                }, 2000);
                
                // 키보드 단축키 설정
                this.setupKeyboardShortcuts();
                
                // 스크롤 기반 진전 항목 선택 표시
                this.setupScrollBasedHighlighting();
            }
            
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Alt + H: 현재 결과로 이동
                    if (e.altKey && e.key === 'h') {
                        e.preventDefault();
                        document.querySelector('.hero-dashboard').focus();
                    }
                    
                    // Alt + C: 차트로 이동
                    if (e.altKey && e.key === 'c') {
                        e.preventDefault();
                        const firstChart = document.querySelector('.chart-container');
                        if (firstChart) firstChart.focus();
                    }
                    
                    // Alt + A: 조언로 이동
                    if (e.altKey && e.key === 'a') {
                        e.preventDefault();
                        const advice = document.getElementById('customAdvice');
                        if (advice) advice.focus();
                    }
                });
            }
            
            setupScrollBasedHighlighting() {
                const cards = document.querySelectorAll('.result-card, .column-card');
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('in-view');
                        } else {
                            entry.target.classList.remove('in-view');
                        }
                    });
                }, {
                    threshold: 0.5
                });
                
                cards.forEach(card => observer.observe(card));
            }
        }

        // === 향상된 앱 초기화 ===
        document.addEventListener('DOMContentLoaded', async () => {
            // 로딩 표시
            showLoadingState();
            
            try {
                // 분석 데이터 초기화
                await initializeAnalysisData();
                
                // 데이터가 준비되면 컨트롤러 초기화
                new ResultsFinalController(analysisData);
                
                // 로딩 상태 제거
                hideLoadingState();
                
            } catch (error) {
                console.error('앱 초기화 실패:', error);
                
                // 에러 발생 시 기본 데이터로 초기화
                analysisData = getDefaultAnalysisData();
                new ResultsFinalController(analysisData);
                
                hideLoadingState();
                
                if (window.showNotification) {
                    window.showNotification('데이터 로딩에 실패했습니다. 데모 데이터를 표시합니다.', 'warning');
                }
            }
        });
        
        // 향상된 로딩 상태 처리
        function showLoadingState() {
            const heroSection = document.querySelector('.hero-dashboard');
            if (heroSection) {
                heroSection.innerHTML = `
                    <div style="text-align: center; padding: 2rem;" role="status" aria-live="polite">
                        <div class="loading-animation" style="margin: 0 auto 1rem; width: 60px; height: 60px;">
                            <i class="fas fa-heart" style="font-size: 2rem; color: #ec4899; animation: pulse 1.5s ease-in-out infinite;"></i>
                        </div>
                        <h2 style="color: var(--text-primary); margin-bottom: 0.5rem;">분석 결과를 불러오는 중...</h2>
                        <p style="color: var(--text-secondary);">잠시만 기다려주세요. AI가 대화를 분석하고 있습니다.</p>
                        <div class="progress-indicator" style="width: 100%; height: 4px; background: #f3f4f6; border-radius: 2px; margin-top: 1rem; overflow: hidden;">
                            <div class="progress-bar" style="width: 0%; height: 100%; background: var(--primary-gradient); animation: progress 3s ease-in-out infinite;"></div>
                        </div>
                    </div>
                `;
                
                // CSS 애니메이션 동적 추가
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.1); opacity: 0.7; }
                    }
                    @keyframes progress {
                        0% { width: 0%; }
                        50% { width: 70%; }
                        100% { width: 100%; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // 로딩 상태 제거
        function hideLoadingState() {
            // 로딩 메시지는 ResultsFinalController에서 실제 데이터로 교체됨
        }
    </script>
    
    <!-- 접근성 개선: Skip Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- JSON-LD 구조화 데이터 -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Date Genie - AI 관계 분석",
        "description": "AI 기반 대화 분석을 통한 정확한 관계 진단 및 맞춤화된 전략 제공",
        "applicationCategory": "RelationshipAnalysisApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "KRW"
        }
    }
    </script>
</body>
</html>